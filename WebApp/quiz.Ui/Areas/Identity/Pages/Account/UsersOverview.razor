@page "/Identity/Account/UsersOverview"

@attribute [Authorize(Roles = "Администраторы")]

@using quiz.Ui.Components
@using quiz.Ui.Pages.Admin

<PageTitle>Пользователи</PageTitle>

<LayoutView Layout="@typeof(AdminLayout)">
    <h3>Пользователи</h3>

    <div class="card border-primary mt-2 mb-3">
        @* Заголовок карточки *@
        <div class="card-header h5">Список пользователей</div>
        @* Тело карточки *@
        <div class="card-body">
            <div class="card-text">
                @* Если данные в контрол ещё не загружены полностью, то *@
                @if (!IsLoaded)
                {
                    @* Отображение пользователю надписи "Загрузка". *@
                    <DxLoadingPanel Visible="true"
                                    Text="Загрузка..."
                                    ApplyBackgroundShading="false"
                                    IndicatorAnimationType="WaitIndicatorAnimationType.Spin">
                    </DxLoadingPanel>
                }
                else
                {
                    @* Если при взаимодействии с WebAPI были произошли ошибки, то *@
                    @if (HasWebApiErrors)
                    {
                        @* Информация о проблемах взаимодействия с WebAPI *@
                        <div class="alert alert-danger mt-2">@WebApiErrorsDescription</div>
                    }
                    else
                    {
                        @* Если нет данных для отображения, то *@
                        @if (Objects == null || !Objects.Any())
                        {
                            // Отображение пользователю надписи "Нет данных".
                            <p class="align-middle"><em>Нет данных</em></p>
                        }
                        else
                        {
                            @* Таблица со списком объектов. *@
                            <DxGrid Data="@Objects"
                                    KeyFieldName="Id"
                                    SelectionMode="GridSelectionMode.Single"
                                    @bind-SelectedDataItem="@SelectedItemObject"
                                    FooterDisplayMode="GridFooterDisplayMode.Auto"
                                    AllowSelectRowByClick="true">
                                <Columns>
                                    <DxGridDataColumn FieldName="Login"
                                                      Caption="Логин"
                                                      TextAlignment="GridTextAlignment.Center"
                                                      CaptionAlignment="GridTextAlignment.Center" />
                                    <DxGridDataColumn FieldName="Email"
                                                      Caption="Email"
                                                      TextAlignment="GridTextAlignment.Center"
                                                      CaptionAlignment="GridTextAlignment.Center" />
                                    <DxGridDataColumn FieldName="CreatedAt"
                                                      Caption="Дата создания"
                                                      DisplayFormat="g"
                                                      TextAlignment="GridTextAlignment.Center"
                                                      CaptionAlignment="GridTextAlignment.Center" />
                                    @* Отображение списка ролей, в которые входит пользователь *@
                                    <DxGridDataColumn 
                                        FieldName="RolesCaption" 
                                        Caption="Роли"
                                        TextAlignment="GridTextAlignment.Center"
                                        CaptionAlignment="GridTextAlignment.Center">
                                        <CellDisplayTemplate Context="displayContext">
                                            <div class="text-wrap" >@displayContext.DisplayText</div>
                                        </CellDisplayTemplate>
                                    </DxGridDataColumn>
                                </Columns>
                                <TotalSummary>
                                    @* Информация о количестве записей в таблице отображается в нижней части таблицы если записей не менее 7 *@
                                    <DxGridSummaryItem
                                        SummaryType="GridSummaryItemType.Count"
                                        FieldName="Login"
                                        DisplayText=@($"Всего записей: {Objects.Count()}")
                                        FooterColumnName="RolesCaption"
                                        Visible=@(Objects.Count() >= 7)/>
                                </TotalSummary>
                            </DxGrid>
                        }
                    }

                    <div class="row">
                        @* Рамка отступов вокруг кнопок управления *@
                        <div class="col-lg d-lg-flex align-content-stretch mx-1 mt-1">
                            <button type="button" @onclick="UserAdd" class="btn btn-outline-primary text-center col-auto m-1">Добавить</button>
                            <button type="button" @onclick="() => UserEdit(SelectedItem?.Id ?? Guid.Empty)" class="btn btn-outline-primary text-center m-1" disabled="@(SelectedItem == null)">Редактировать</button>
                            <button type="button" @onclick="ObjectDeleteAsync" class="btn btn-outline-primary text-center m-1" disabled="@(IsDeleteButtonDisabled || SelectedItem == null)">Удалить</button>
                        </div>
                    </div>

                    // Подключение диалоговых окон - popup-окно подтверждения удаления.
                    <DialogDelete @ref="ObjectDeleteDialog" DeletedSuccessfullyEventCallback="@DeleteDialogUser_OnDeletedSuccessfully" ObjectDataService="@ObjectDataService" ObjectToDeleteId="@SelectedItem?.Id"></DialogDelete>
                }
            </div>
        </div>
    </div>
</LayoutView>
